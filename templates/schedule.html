{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Schedule | SchoolSync</title>
<link rel="stylesheet" href="{% static 'home/style.css' %}">
<link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root {
      --card: #fff;
      --bg: #F6F8FB;
      --muted: #6B7280;
      --brand: #1d1b31;
      --accent: #EF4444;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(2,6,23,0.06);
    }

    body {
      font-family: "Poppins", sans-serif;
      margin: 0;
      background: #f4f7fc;
    }

    .home-section {
      position: relative;
      min-height: 100vh;
      width: calc(100% - 78px);
      left: 78px;
      transition: 0.5s;
      padding: 40px 30px;
    }

    .sidebar.open ~ .home-section {
      left: 250px;
      width: calc(100% - 250px);
    }

    .schedule-container {
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    }

    .schedule-container h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 1.8rem;
    }

    #scheduleForm {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    #scheduleForm input,
    #scheduleForm select,
    #scheduleForm textarea {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 0.95rem;
    }

    #scheduleForm button {
      background: #2b284a;
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    #scheduleForm button:hover {
      background: #2e4cbb;
    }

    .filter-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-bar input,
    .filter-bar select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      flex: 1;
      min-width: 120px;
    }

    #scheduleList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .event-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.05);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.2s;
    }

    .event-card:hover {
      transform: translateY(-4px);
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .event-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: #333;
    }

    .event-header small {
      color: #6b7280;
      font-size: 0.85rem;
    }

    .event-desc {
      color: #555;
      font-size: 0.9rem;
      margin-bottom: 10px;
      word-wrap: break-word;
    }

    .event-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .event-actions button {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .edit-btn {
      background: #ffb703;
      color: #fff;
    }

    .edit-btn:hover {
      background: #f48c06;
    }

    .del-btn {
      background: #f3f4f6;
      color: #ef4444;
      border: 1px solid #ef4444;
    }

    .del-btn:hover {
      background: #ef4444;
      color: #fff;
    }

    /* highlight active sidebar item */
    .sidebar.open li.active a{ background: #1d1b31; }
    .sidebar .nav-list a.active {
      background: #1d1b31;
      color: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar .nav-list li.active .links_name,
    .sidebar .nav-list a.active .links_name {
      color: #ffffff !important;
    }

    .sidebar .nav-list a.active i {
      color: #fff;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      position: relative;
    }

    .modal-header {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      color: #333;
    }

    .modal-content input,
    .modal-content select,
    .modal-content textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .modal-content button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #4b70e2;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.3s;
    }

    .modal-content button:hover {
      background: #2e4cbb;
    }

    @media(max-width:640px) {
      #scheduleForm, .filter-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="sidebar">
  <div class="logo-details">
    <i class='bx bxl-c-plus-plus icon'></i>
    <div class="logo_name">SchoolSync</div>
    <i class='bx bx-menu' id="btn" ></i>
  </div>
  <ul class="nav-list">
      <li><a href="/dashboard/"><i class='bx bx-home'></i> <span class="links_name">Home</span></a></li>
      <li><a href="/groups/"><i class='bx bx-group'></i> <span class="links_name">Groups</span></a></li>
      <li><a href="/homework/"><i class='bx bx-book'></i> <span class="links_name">Homework</span></a></li>
      <li><a href="/quizzes/"><i class='bx bx-dice-5'></i> <span class="links_name">Quizzes</span></a></li>
      
      <li><a href="/schedule/"  class="active"><i class='bx bx-calendar-alt'></i> <span class="links_name">Schedule</span></a></li>
        <li style="position:relative">
        <a href="#" id="notifBellBtn" style="display:flex;align-items:center;gap:8px;color:inherit;text-decoration:none;">
          <i class='bx bx-bell'></i>
          <span class="links_name">Notifications</span>
          <span id="notifBadge" style="display:none;position:absolute;left:34px;top:-4px;background:#ef4444;color:#ffffff;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:700;">0</span>
        </a>
        <div id="notifDropdown" style="display:none;position:absolute;left:0;top:46px;z-index:999;background:var(--card);box-shadow:0 6px 20px rgba(0, 0, 0, 0.12);width:320px;border-radius:8px;padding:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Notifications</strong><button id="markAllRead" class="btn small">Mark all read</button></div>
          <div id="notifList" style="max-height:300px;overflow:auto;"></div>
          <div id="notifEmpty" style="color:var(--muted);text-align:center;padding:10px;display:none">No notifications</div>
        </div>
      </li>
      <li class="profile">
        <div class="profile-details">
          <i class='bx bx-user'></i>
          <div class="name_job">
            <div class="name">{{ username }}</div>
            <div class="job">{{ user.school_year }}</div>
          </div>
        </div>
      <a href="#" id="log_out" style="color:#fff">Logout</a>
    </li>
  </ul>
</div>

<section class="home-section">
  <div class="schedule-container">
    <h2>Your Schedule</h2>
    <form id="scheduleForm">
      <input type="text" id="title" placeholder="Event title *" required>
      <input type="datetime-local" id="datetime" required>
      <select id="eventType" required>
        <option value="">Select type *</option>
        <option value="class">Class</option>
        <option value="assignment">Assignment</option>
        <option value="exam">Exam</option>
        <option value="other">Other</option>
      </select>
      <textarea id="description" placeholder="Event description"></textarea>
      <button type="submit">Add Event</button>
    </form>
    <div class="filter-bar">
      <input type="text" id="search" placeholder="Search events...">
      <select id="filterType">
        <option value="">All types</option>
        <option value="class">Class</option>
        <option value="assignment">Assignment</option>
        <option value="exam">Exam</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div id="scheduleList"></div>
  </div>
</section>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <div class="modal-header">Edit Event</div>
    <input type="text" id="editTitle" placeholder="Event title *" required>
    <input type="datetime-local" id="editDatetime" required>
    <select id="editType" required>
      <option value="">Select type *</option>
      <option value="class">Class</option>
      <option value="assignment">Assignment</option>
      <option value="exam">Exam</option>
      <option value="other">Other</option>
    </select>
    <textarea id="editDescription" placeholder="Event description"></textarea>
    <button id="saveEditBtn">Save Changes</button>
  </div>
</div>

<script>
const apiBase='/api/schedule/';
const csrftoken=(document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'';

function showNotification(msg,type='info',t=3500){
  let container=document.getElementById('notification-container');
  if(!container){container=document.createElement('div');container.id='notification-container';container.style.position='fixed';container.style.top='18px';container.style.right='18px';container.style.zIndex='9999';document.body.appendChild(container);}
  const el=document.createElement('div');el.textContent=msg;
  el.style.padding='10px 14px';el.style.borderRadius='8px';el.style.marginTop='8px';el.style.fontWeight='700';
  el.style.boxShadow='0 6px 18px rgba(2,6,23,0.08)';
  if(type==='success'){el.style.background='linear-gradient(90deg,#10b981,#06b6d4)';el.style.color='#fff';}
  else if(type==='error'){el.style.background='#ef4444';el.style.color='#fff';}
  else{el.style.background='#111827';el.style.color='#fff';}
  container.appendChild(el);setTimeout(()=>el.remove(),t);
}

let eventsData=[];
let currentEditId=null;

async function loadSchedule(){
  try{
    const res=await fetch(apiBase,{credentials:'same-origin'});
    if(!res.ok) throw new Error('Network');
    eventsData=await res.json(); renderEvents();
  }catch(err){document.getElementById('scheduleList').innerHTML='<div style="color:#6b7280">Could not load events</div>';}
}

function renderEvents(){
  const list=document.getElementById('scheduleList'); list.innerHTML='';
  let filtered=[...eventsData];
  const search=document.getElementById('search').value.toLowerCase();
  const typeFilter=document.getElementById('filterType').value;
  if(search) filtered=filtered.filter(e=>e.title.toLowerCase().includes(search)||(e.description||'').toLowerCase().includes(search));
  if(typeFilter) filtered=filtered.filter(e=>e.type===typeFilter);
  if(filtered.length===0){list.innerHTML='<div style="color:#6b7280">No events found</div>';return;}
  filtered.forEach(ev=>{
    const el=document.createElement('div'); el.className='event-card';
    const colorMap={class:'#4b70e2',assignment:'#facc15',exam:'#ef4444',other:'#10b981'};
    el.style.borderLeft='5px solid '+(colorMap[ev.type]||'#4b70e2');
    const header=document.createElement('div'); header.className='event-header';
    header.innerHTML=`<h3>${ev.title}</h3><small>${new Date(ev.datetime).toLocaleString()}</small>`;
    const desc=document.createElement('div'); desc.className='event-desc'; desc.textContent=ev.description||'';
    const actions=document.createElement('div'); actions.className='event-actions';
    const edit=document.createElement('button'); edit.className='edit-btn'; edit.innerHTML='<i class="bx bx-edit"></i> Edit';
    edit.addEventListener('click',()=>openEditModal(ev));
    const del=document.createElement('button'); del.className='del-btn'; del.innerHTML='<i class="bx bx-trash"></i> Delete';
    del.addEventListener('click',async()=>{
      if(!confirm('Delete this event?')) return;
      const r=await fetch(`${apiBase}${ev.id}/`,{method:'DELETE',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}});
      if(r.ok){showNotification('Event deleted','success'); loadSchedule();} else showNotification('Could not delete event','error');
    });
    actions.appendChild(edit); actions.appendChild(del);
    el.appendChild(header); el.appendChild(desc); el.appendChild(actions);
    list.appendChild(el);
  });
}

document.getElementById('scheduleForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const title=document.getElementById('title').value.trim();
  const datetime=document.getElementById('datetime').value;
  const description=document.getElementById('description').value.trim();
  const type=document.getElementById('eventType').value;
  if(!title||!datetime||!type){showNotification('Title, date/time and type are required','error'); return;}
  try{
    const r=await fetch(apiBase,{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},body:JSON.stringify({title,datetime,description,type})});
    if(!r.ok) throw new Error('Create failed');
    showNotification('Event created','success'); e.target.reset(); loadSchedule();
  }catch(err){showNotification(err.message||'Could not create event','error');}
});

function openEditModal(ev){
  currentEditId=ev.id;
  document.getElementById('editTitle').value=ev.title;
  document.getElementById('editDatetime').value=new Date(ev.datetime).toISOString().slice(0,16);
  document.getElementById('editDescription').value=ev.description||'';
  document.getElementById('editType').value=ev.type||'class';
  document.getElementById('editModal').style.display='block';
}

document.querySelector('.close-btn').addEventListener('click',()=>{document.getElementById('editModal').style.display='none';});
window.onclick = function(event){if(event.target == document.getElementById('editModal')){document.getElementById('editModal').style.display='none';}};

document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
  const title=document.getElementById('editTitle').value.trim();
  const datetime=document.getElementById('editDatetime').value;
  const description=document.getElementById('editDescription').value.trim();
  const type=document.getElementById('editType').value;
  if(!title||!datetime||!type){showNotification('All fields required','error'); return;}
  try{
    const r=await fetch(`${apiBase}${currentEditId}/`,{method:'PUT',credentials:'same-origin',headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},body:JSON.stringify({title,datetime,description,type})});
    if(!r.ok) throw new Error('Update failed');
    showNotification('Event updated','success'); document.getElementById('editModal').style.display='none'; loadSchedule();
  }catch(err){showNotification(err.message||'Could not update event','error');}
});

document.getElementById('search').addEventListener('input',renderEvents);
document.getElementById('filterType').addEventListener('change',renderEvents);

const sidebar=document.querySelector('.sidebar'); const closeBtn=document.querySelector('#btn');
if(closeBtn){closeBtn.addEventListener('click',()=>{sidebar.classList.toggle('open'); if(sidebar.classList.contains('open')) closeBtn.classList.replace('bx-menu','bx-menu-alt-right'); else closeBtn.classList.replace('bx-menu-alt-right','bx-menu');});}

document.addEventListener('DOMContentLoaded',loadSchedule);
// notification badge loader
async function loadNotificationsSC(){
  try{
    const res = await fetch('/api/notifications', { credentials:'same-origin' });
    if(!res.ok) return;
    const data = await res.json();
    const unread = data.filter(n=>!n.is_read).length;
    const b = document.getElementById('notifBadge_sc'); if(!b) return;
    if(unread>0){ b.style.display='inline-block'; b.textContent = unread>99? '99+' : String(unread); } else b.style.display='none';
  }catch(e){ console.error(e); }
}
document.addEventListener('DOMContentLoaded', loadNotificationsSC);
</script>
<script>
    // Notifications: fetch and render badge/dropdown
    const notifApi = '/api/notifications';
    async function loadNotifications(){
      try{
        const res = await fetch(notifApi, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Failed to load notifications');
        const data = await res.json();
        const unread = data.filter(n=>!n.is_read).length;
        const badge = document.getElementById('notifBadge');
        if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread>99? '99+' : String(unread); }
        else { badge.style.display='none'; }
        const list = document.getElementById('notifList'); list.innerHTML='';
        if(!data || data.length===0){ document.getElementById('notifEmpty').style.display='block'; return; } else document.getElementById('notifEmpty').style.display='none';
        data.forEach(n=>{
          const item = document.createElement('div');
          item.style.padding='8px'; item.style.borderBottom='1px solid #eef2f6'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
          item.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(n.message)}</div><div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div></div>`;
          const right = document.createElement('div'); right.style.marginLeft='8px';
          const mark = document.createElement('button'); mark.className='btn small'; mark.textContent = n.is_read? 'Read' : 'Mark';
          mark.onclick = async ()=>{
            if(n.is_read) return; // no-op
            const r = await fetch(`/api/notifications/${n.id}/read`, { method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'' } });
            if(r.ok){ n.is_read = true; mark.textContent='Read'; loadNotifications(); }
            else showNotification('Could not mark notification','error');
          };
          right.appendChild(mark);
          item.appendChild(right);
          list.appendChild(item);
        });
      }catch(e){ console.error(e); }
    }

    document.getElementById('notifBellBtn').addEventListener('click', (e)=>{
      e.preventDefault(); const d = document.getElementById('notifDropdown'); d.style.display = d.style.display==='none' || d.style.display===''? 'block' : 'none'; if(d.style.display==='block') loadNotifications();
    });

    document.getElementById('markAllRead').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const list = document.getElementById('notifList');
        const items = Array.from(list.children);
        for(const it of items){
          const btn = it.querySelector('button'); if(!btn) continue; btn.click();
        }
      }catch(err){ console.error(err); }
    });

    // load on start to populate badge
    loadNotifications();
  </script>
</body>
</html>
