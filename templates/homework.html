{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Homework | SchoolSync</title>
  <link rel="stylesheet" href="{% static 'home/style.css' %}">
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Inline critical CSS fallback -->
  <style>
    :root {
      --card:#fff;
      --bg:#F6F8FB;
      --muted:#6B7280;
      --brand:#1d1b31;
      --accent:#EF4444;
    }
    body { background:var(--bg); font-family:Inter, system-ui, sans-serif; color:#0f172a; }
    .hw-container { max-width:980px; margin:24px auto; padding:18px; }
    .hw-form { background:var(--card); padding:14px; border-radius:10px; box-shadow:0 8px 24px rgba(15,23,42,0.04); display:none; }
    .hw-form select, .hw-form input, .hw-form textarea { border:1px solid #E6E9EE; padding:8px 10px; border-radius:8px; }
    .hw-post { background:var(--card); padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 8px 20px rgba(15,23,42,0.04); }
    .meta { display:flex; justify-content:space-between; align-items:center; }
    .badge { padding:6px 8px; border-radius:999px; background:#F1F5F9; font-weight:600; margin-left:6px; }
    .actions { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .btn, .small-btn { font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
    .btn.primary { background: var(--brand); color: #fff; padding: 10px 16px; border-radius: 10px; border: none; box-shadow: 0 4px 12px rgba(29,27,49,0.2); }
    .btn.primary:hover { background: #292644; transform: translateY(-1px); }
    .small-btn.secondary { background: transparent; color: var(--brand); border: 2px solid var(--brand); padding: 6px 12px; border-radius: 8px; }
    .small-btn.secondary:hover { background: var(--brand); color: #fff; }
    .small-btn { background: #f9fafb; border: 1px solid #e6e9ee; color: var(--brand); padding: 6px 12px; border-radius: 8px; }
    .small-btn:hover { background: #f1f5f9; }
  /* Danger variant for destructive actions */
  .small-btn.danger { background: #fff; border: 1px solid #ef4444; color: #ef4444; }
  .small-btn.danger:hover { background: #ef4444; color: #fff; }
    /* Floating + button */
    .fab {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--brand);
      color: #fff;
      font-size: 28px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: 0.2s;
      z-index: 1000;
    }
    .fab:hover { background:#292644; transform:scale(1.05); }
    .filter-bar {
  background: var(--card);
  padding: 10px 14px;
  border-radius: 10px;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
  box-shadow: 0 4px 12px rgba(15,23,42,0.05);
}

.filter-group {
  display: flex;
  flex-direction: column;
  font-size: 14px;
  color: var(--muted);
}

.filter-group label {
  font-size: 12px;
  margin-bottom: 2px;
  font-weight: 600;
  color: #374151;
}

.filter-group select,
.filter-group input {
  padding: 6px 8px;
  border: 1px solid #e6e9ee;
  border-radius: 8px;
  font-size: 14px;
  min-width: 120px;
}

  /* right-side drawer for comments (preferred) */
  .hw-drawer{ position:fixed; right:-440px; top:0; height:100%; width:420px; max-width:94%; background:#fff; box-shadow: -20px 0 40px rgba(2,6,23,0.12); z-index:1600; transition: right .28s cubic-bezier(.2,.9,.2,1), transform .28s; transform: translateX(0); display:flex; flex-direction:column }
  .hw-drawer.open{ right:0; transform: translateX(0) }
  .hw-drawer-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.36); z-index:1590; opacity:0; pointer-events:none; transition: opacity .2s ease }
  .hw-drawer-backdrop.open{ opacity:1; pointer-events:auto }
  .hw-drawer .drawer-header{ padding:16px; border-bottom:1px solid #eef2ff; display:flex; align-items:center; justify-content:space-between }
  .hw-drawer .drawer-body{ padding:14px; overflow:auto; flex:1 }
  .hw-drawer .drawer-footer{ padding:12px; border-top:1px solid #f1f5f9 }
  .hw-drawer .comment-item{ padding:10px; border-radius:10px; background:#fbfbfd; margin-bottom:8px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between }
  .hw-drawer .comment-item.enter{ animation: fadeIn .18s ease both }
  @keyframes fadeIn { from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none} }
  .hw-drawer .avatar{ width:40px; height:40px; border-radius:50%; background:#eef2ff; display:flex; align-items:center; justify-content:center; font-weight:700; color:#0f172a; flex:0 0 40px }

  /* Sidebar active link styling */
  .sidebar .nav-list a.active { background: var(--brand); color: #fff; border-radius: 8px; padding: 8px 10px; display: inline-flex; align-items: center; gap:8px }
  .sidebar .nav-list li.active .links_name, .sidebar .nav-list a.active .links_name { color: #000000 !important }
  .sidebar .nav-list a.active i { color: #fff }

  </style>
</head>
<body data-current-user-id="{{ user.id|default:0 }}">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo-details">
      <i class='bx bxl-c-plus-plus icon'></i>
      <div class="logo_name">schoolsync</div>
      <i class='bx bx-menu' id="btn" ></i>
    </div>
    <ul class="nav-list">
      <li>
       <i class="bx bx-search" style="display:none"></i>

        
        <span class="tooltip">Search</span>
      </li>
      <li>
       <a href="/dashboard/">
         <i class='bx  bx-home'  ></i> 
         <span class="links_name">Home</span>
       </a>
       <span class="tooltip">Home</span>
     </li>
      <li>
        <a href="/groups/"><i class='bx bx-group'></i><span class="links_name">Groups</span></a>
        <span class="tooltip">Group</span>
      </li>
      <li>
        <a href="/homework/"><i class='bx bx-book'></i><span class="links_name">Homeworks</span></a>
        <span class="tooltip">Homework</span>
      </li>
      
      <li>
       <a href="/quizzes/">
         <i class='bx  bx-dice-5'  ></i> 
         <span class="links_name">Quizzes</span>
       </a>
       <span class="tooltip">Quize</span>
     </li>
     <li>
       <a href="/schedule/">
        <i class='bx  bx-calendar-alt'  ></i> 
         <span class="links_name">schedule</span>
       </a>
       <span class="tooltip">schedule</span>
     </li>
     <li style="position:relative">
       <a href="#" id="notifBellBtn_hw" style="display:flex;align-items:center;gap:8px;color:inherit;text-decoration:none;">
         <i class='bx bx-bell'></i><span class="links_name">Notifications</span>
         <span id="notifBadge_hw" style="display:none;position:absolute;left:40px;top:-6px;background:#ef4444;color:#fff;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:700;">0</span>
       </a>
     </li>
     
      <li class="profile">
        <div class="profile-details">
          <i class='bx bx-user'></i>
          <div class="name_job">
            <div class="name">{{ username }}</div>
            <div class="job">{{ user.school_year }}</div>
          </div>
        </div>
        <a href="#" id="log_out" style="color:#fff">Logout</a>
      </li>
    </ul>
  </div>

  <!-- Main Section -->
  <section class="home-section">
    <div class="text">Homework</div>
    <div class="hw-container">
      <h2>Homework Hub</h2>
      <!-- Create Form (hidden until + clicked) -->
      <div class="hw-form" id="postForm">
        <form id="createNote">
          <div class="controls">
            <select name="grade"><option>9</option><option>10</option><option>11</option><option>12</option></select>
            <input name="subject" placeholder="Subject">
            <select name="category"><option value="Q">Question</option><option value="T">Tip</option><option value="R">Resource</option></select>
            <select name="note_type"><option value="HW">Homework</option><option value="EX">Exam Prep</option><option value="GEN">General</option></select>
          </div>
          <div style="margin-top:10px"><textarea name="content" rows="3" style="width:100%" placeholder="Ask or share..." required></textarea></div>
          <div class="actions" style="margin-top:8px"><button class="btn primary" type="submit"><i class='bx bx-plus' style='margin-right:6px'></i>Post</button></div>
        </form>
      </div>
      <!-- Filter Section -->
<div class="filter-bar">
  <div class="filter-group">
    <label>Grade:</label>
    <select id="filterGrade">
      <option value="">All</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
    </select>
  </div>

  <div class="filter-group">
    <label>Subject:</label>
    <input id="filterSubject" placeholder="e.g. Math">
  </div>

  <div class="filter-group">
    <label>Type:</label>
    <select id="filterType">
      <option value="">All</option>
      <option value="HW">Homework</option>
      <option value="EX">Exam Prep</option>
      <option value="GEN">General</option>
    </select>
  </div>

  <div class="filter-group">
    <label>Category:</label>
    <select id="filterCategory">
      <option value="">All</option>
      <option value="Q">Question</option>
      <option value="T">Tip</option>
      <option value="R">Resource</option>
    </select>
  </div>

  <button id="applyFilters" class="btn primary">Apply</button>
</div>

      <!-- Posts -->
      <div id="posts"></div>
    </div>
  </section>

  <!-- Floating + Button -->
  <button id="togglePostForm" class="fab">+</button>

  <div id="notification-container" style="position:fixed;top:20px;right:20px;z-index:9999"></div>

  <!-- old modal removed: using the right-side drawer for comments -->

  <!-- Right-side drawer for comments (preferred UX) -->
  <aside id="hw-drawer" class="hw-drawer" aria-hidden="true">
    <div class="drawer-header">
      <div>
        <h3 id="drawerTitle" style="margin:0">Post</h3>
        <div id="drawerMeta" style="font-size:13px;color:#666"></div>
      </div>
      <button id="drawerClose" class="small-btn">×</button>
    </div>
    <div class="drawer-body">
      <div id="drawerComments"></div>
    </div>
    <div class="drawer-footer">
      <div style="display:flex;gap:8px"><textarea id="drawerNewComment" rows="2" style="flex:1;border:1px solid #e6e9ee;padding:8px;border-radius:8px"></textarea><button id="drawerAddComment" class="btn primary">Comment</button></div>
    </div>
  </aside>
  <div id="hw-drawer-backdrop" class="hw-drawer-backdrop" aria-hidden="true"></div>
  <script>
    async function loadNotificationsHW(){
      try{ const res = await fetch('/api/notifications', { credentials:'same-origin' }); if(!res.ok) return; const data = await res.json(); const unread = data.filter(n=>!n.is_read).length; const b=document.getElementById('notifBadge_hw'); if(!b) return; if(unread>0){ b.style.display='inline-block'; b.textContent= unread>99? '99+' : String(unread);} else b.style.display='none'; }catch(e){ console.error(e); }
    }
    document.addEventListener('DOMContentLoaded', loadNotificationsHW);
  </script>

  <script>
    const csrftoken = (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'';
    const CURRENT_USER_ID = parseInt(document.body.dataset.currentUserId||'0',10);

    // Sidebar toggle
    const sidebar=document.querySelector(".sidebar"), closeBtn=document.querySelector("#btn"), searchBtn=document.querySelector(".bx-search");
    closeBtn.onclick=()=>{sidebar.classList.toggle("open"); closeBtn.classList.toggle("bx-menu-alt-right"); closeBtn.classList.toggle("bx-menu");}
    searchBtn.onclick=()=> closeBtn.onclick();

    // Logout
    document.getElementById('log_out').onclick=async e=>{
      e.preventDefault(); await fetch('/api/auth/logout',{method:'POST',credentials:'same-origin'}); window.location='/';
    }

    function showNotification(msg,type='info',t=3500){
      const c=document.getElementById('notification-container'); const el=document.createElement('div');
      el.textContent=msg; el.style=(type==='error')?'background:#b83131;color:#fff;padding:8px 12px;border-radius:6px;margin-top:8px':(type==='success')?'background:#1d1b31;color:#fff;padding:8px 12px;border-radius:6px;margin-top:8px':'background:#333;color:#fff;padding:8px 12px;border-radius:6px;margin-top:8px';
      c.appendChild(el); setTimeout(()=>el.remove(),t);
    }

    function renderPost(p){
      const div=document.createElement('div'); div.className='hw-post'; div.dataset.postId=p.id;
      const badges=`<span class="badge">${p.category||'Q'}</span><span class="badge">${p.note_type==='HW'?'Homework':p.note_type==='EX'?'Exam Prep':'General'}</span>`;
      div.innerHTML=`<div class="meta"><div><strong>${p.subject||'—'}</strong> · Grade ${p.grade}</div><div>${badges} <span class="likes">${p.likes_count||0}</span> <i class='bx bx-heart'></i> <span class='comment-count'>${(p.comments||[]).length}</span></div></div><div class="content">${p.content}</div>`;
      // Actions
      const actions=document.createElement('div'); actions.className='actions';
      const likeBtn=document.createElement('button'); likeBtn.className='small-btn'; likeBtn.innerHTML=`<i class="bx ${p.liked? 'bxs-heart' : 'bx-heart'}" style="margin-right:6px"></i>Like`;
      likeBtn.onclick=async()=>{
        const r=await fetch(`/api/homework/${p.id}/like`,{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}});
        if(r.ok){
          const data=await r.json();
          div.querySelector('.likes').textContent=data.likes_count;
          const ic = likeBtn.querySelector('i');
          if(ic) ic.className = 'bx ' + (data.liked ? 'bxs-heart' : 'bx-heart');
        }
      }
      actions.appendChild(likeBtn);
  const openBtn=document.createElement('button'); openBtn.className='small-btn secondary'; openBtn.textContent='Open'; openBtn.onclick=()=>openDrawer(p); actions.appendChild(openBtn);
      if(p.author&&p.author.id===CURRENT_USER_ID){
        const del=document.createElement('button'); del.className='small-btn danger'; del.textContent='Delete';
        del.onclick=async()=>{if(!confirm('Delete?'))return;const r=await fetch(`/api/homework/${p.id}`,{method:'DELETE',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}});if(r.ok)div.remove();else showNotification('Delete failed','error');};
        actions.appendChild(del);
      }
      div.appendChild(actions); return div;
    }

    async function loadPosts(){
      const g=document.getElementById('filterGrade').value, s=document.getElementById('filterSubject').value.trim(), t=document.getElementById('filterType').value, c=document.getElementById('filterCategory').value;
      const params=new URLSearchParams(); if(g)params.set('grade',g); if(s)params.set('subject',s); if(t)params.set('note_type',t); if(c)params.set('category',c);
      const res=await fetch('/api/homework?'+params,{credentials:'same-origin'}); if(!res.ok){showNotification('Could not load posts','error'); return;}
      const posts=await res.json(); const container=document.getElementById('posts'); container.innerHTML=''; posts.forEach(p=>container.appendChild(renderPost(p)));
    }

    // Drawer (right-side) — opens comments in a separate panel so they don't push content down
    let __lastActiveElement = null;
    function openDrawer(post){
      document.getElementById('drawerTitle').textContent = `${post.subject||'—'} • Grade ${post.grade}`;
      document.getElementById('drawerMeta').textContent = post.content;
      const drawer = document.getElementById('hw-drawer');
      const backdrop = document.getElementById('hw-drawer-backdrop');
      // save focus so we can restore after closing
      __lastActiveElement = document.activeElement;
      drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
      backdrop.classList.add('open'); backdrop.setAttribute('aria-hidden','false');
      // load comments and move focus to close button
      loadCommentsDrawer(post.id).then(()=>{
        const closeBtn = document.getElementById('drawerClose');
        if(closeBtn){ closeBtn.focus(); }
      });
    }

    // Close drawer and restore focus
    function closeDrawer(){
      const d = document.getElementById('hw-drawer');
      const b = document.getElementById('hw-drawer-backdrop');
      d.classList.remove('open'); d.setAttribute('aria-hidden','true');
      b.classList.remove('open'); b.setAttribute('aria-hidden','true');
      // restore focus
      try{ if(__lastActiveElement && typeof __lastActiveElement.focus === 'function') __lastActiveElement.focus(); }catch(e){}
    }
    document.getElementById('drawerClose').onclick = ()=> closeDrawer();

    async function loadCommentsDrawer(postId){
      const res = await fetch(`/api/homework/${postId}`, {credentials:'same-origin'});
      if(!res.ok) return;
      const post = await res.json();
      const list = document.getElementById('drawerComments');
      list.innerHTML = '';
      post.comments.forEach(c=>{
        const el = document.createElement('div'); el.className='comment-item enter';

        // avatar
        const avatar = document.createElement('div'); avatar.className='avatar'; avatar.style.background = avatarColor(c.author.username);
        avatar.textContent = (c.author.username||'U').trim().slice(0,1).toUpperCase();

        // content wrapper
        const content = document.createElement('div'); content.style.flex = '1';
        const who = document.createElement('strong'); who.style.display = 'block'; who.textContent = c.author.username || 'User';
        const txt = document.createElement('div'); txt.style.marginTop = '6px'; txt.style.color = '#374151'; txt.style.fontSize = '14px'; txt.textContent = c.text;
        const when = document.createElement('div'); when.style.fontSize = '12px'; when.style.color = '#9CA3AF'; when.style.marginTop = '6px'; when.textContent = new Date(c.created_at).toLocaleString();
        content.appendChild(who); content.appendChild(txt); content.appendChild(when);

        // actions (delete)
        const actions = document.createElement('div'); actions.style.marginLeft = '8px'; actions.style.display = 'flex'; actions.style.alignItems = 'start';
        if(c.author.id===CURRENT_USER_ID){
          const del = document.createElement('button'); del.className='small-btn danger'; del.textContent='Delete';
          del.onclick = async ()=>{ const r = await fetch(`/api/homework/comments/${c.id}`, {method:'DELETE', credentials:'same-origin', headers:{'X-CSRFToken':csrftoken}}); if(r.ok) await loadCommentsDrawer(postId); else showNotification('Could not delete','error'); };
          actions.appendChild(del);
        }

        el.appendChild(avatar);
        el.appendChild(content);
        el.appendChild(actions);
        list.appendChild(el);
      });

      // add comment handler (overwrite safely)
      const addBtn = document.getElementById('drawerAddComment');
      const input = document.getElementById('drawerNewComment');
      addBtn.onclick = async ()=>{
        const text = input.value.trim(); if(!text) return; addBtn.disabled = true;
        const r = await fetch(`/api/homework/${postId}/comments`, {method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken}, body: JSON.stringify({text})});
        addBtn.disabled = false;
        if(!r.ok){ showNotification('Could not add comment','error'); return; }
        input.value = '';
        await loadCommentsDrawer(postId);
        const added = document.querySelector('#drawerComments .comment-item'); if(added){ added.classList.add('enter'); added.scrollIntoView({behavior:'smooth', block:'end'}); }
      };
    }

    // Utility: generate a deterministic pastel color from username
    function avatarColor(name){ if(!name) return '#EEF2FF'; let h = 0; for(let i=0;i<name.length;i++){ h = name.charCodeAt(i) + ((h<<5)-h); } const hue = Math.abs(h)%360; return `linear-gradient(135deg,hsl(${hue} 70% 92%), hsl(${(hue+20)%360} 70% 96%))`; }

  // Close handlers: backdrop click and Escape key
  const drawerBackdrop = document.getElementById('hw-drawer-backdrop');
  drawerBackdrop.addEventListener('click', ()=> closeDrawer());
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ const d=document.getElementById('hw-drawer'); if(d.classList.contains('open')){ closeDrawer(); } } });

    // Events
  document.getElementById("applyFilters").onclick = async () => {
  const grade = document.getElementById("filterGrade").value;
  const subject = document.getElementById("filterSubject").value;
  const type = document.getElementById("filterType").value;
  const category = document.getElementById("filterCategory").value;

  const qs = new URLSearchParams({grade, subject, type, category});
  const r = await fetch(`/api/homework?${qs.toString()}`, {credentials:'same-origin'});
  if(r.ok){
    const data = await r.json();
    const postsEl = document.getElementById("posts");
    postsEl.innerHTML = "";
    data.forEach(post => postsEl.append(renderPost(post)));
  }
};
 document.getElementById('createNote').onsubmit=async e=>{
      e.preventDefault(); const fd=new FormData(e.target);
      const payload={grade:fd.get('grade'),subject:fd.get('subject'),category:fd.get('category'),note_type:fd.get('note_type'),content:fd.get('content')};
      const r=await fetch('/api/homework',{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},body:JSON.stringify(payload)});
      if(r.ok){const created=await r.json(); document.getElementById('posts').prepend(renderPost(created)); e.target.reset(); document.getElementById('postForm').style.display='none';} else showNotification('Could not create post','error');
    }

    // Toggle + button
    document.getElementById('togglePostForm').onclick=()=>{
      const form=document.getElementById('postForm');
      form.style.display=form.style.display==='none'?'block':'none';
    }

    loadPosts();
  </script>
  <script>
    // Highlight the active sidebar link based on the current path
    (function(){
      const path = location.pathname.replace(/\/+$/,'') || '/';
      const links = document.querySelectorAll('.nav-list a');
      links.forEach(a=>{
        const href = a.getAttribute('href') || '';
        // normalize
        const norm = href.replace(/\/+$/,'') || '/';
        if(norm === path || (norm !== '/' && path.startsWith(norm))){
          a.classList.add('active');
          // ensure li parent also gets a state for styling
          const li = a.closest('li'); if(li) li.classList.add('active');
        }
      });
    })();
  </script>
    <script>
    // Notifications: fetch and render badge/dropdown
    const notifApi = '/api/notifications';
    async function loadNotifications(){
      try{
        const res = await fetch(notifApi, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Failed to load notifications');
        const data = await res.json();
        const unread = data.filter(n=>!n.is_read).length;
        const badge = document.getElementById('notifBadge');
        if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread>99? '99+' : String(unread); }
        else { badge.style.display='none'; }
        const list = document.getElementById('notifList'); list.innerHTML='';
        if(!data || data.length===0){ document.getElementById('notifEmpty').style.display='block'; return; } else document.getElementById('notifEmpty').style.display='none';
        data.forEach(n=>{
          const item = document.createElement('div');
          item.style.padding='8px'; item.style.borderBottom='1px solid #eef2f6'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
          item.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(n.message)}</div><div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div></div>`;
          const right = document.createElement('div'); right.style.marginLeft='8px';
          const mark = document.createElement('button'); mark.className='btn small'; mark.textContent = n.is_read? 'Read' : 'Mark';
          mark.onclick = async ()=>{
            if(n.is_read) return; // no-op
            const r = await fetch(`/api/notifications/${n.id}/read`, { method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'' } });
            if(r.ok){ n.is_read = true; mark.textContent='Read'; loadNotifications(); }
            else showNotification('Could not mark notification','error');
          };
          right.appendChild(mark);
          item.appendChild(right);
          list.appendChild(item);
        });
      }catch(e){ console.error(e); }
    }

    document.getElementById('notifBellBtn').addEventListener('click', (e)=>{
      e.preventDefault(); const d = document.getElementById('notifDropdown'); d.style.display = d.style.display==='none' || d.style.display===''? 'block' : 'none'; if(d.style.display==='block') loadNotifications();
    });

    document.getElementById('markAllRead').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const list = document.getElementById('notifList');
        const items = Array.from(list.children);
        for(const it of items){
          const btn = it.querySelector('button'); if(!btn) continue; btn.click();
        }
      }catch(err){ console.error(err); }
    });

    // load on start to populate badge
    loadNotifications();
  </script>

</body>
</html>
