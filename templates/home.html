{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | SchoolSync</title>
  <link rel="stylesheet" href="{% static 'home/style.css' %}">
  <link href="https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --brand:#11101D;
      --bg:#f4f7fc;
      --card:#fff;
      --muted:#6b7280;
      --success:#10b981;
      --error:#ef4444;
    }
    body { font-family: Inter, sans-serif; margin:0; background: var(--bg); }

    .home-section {
      position: relative;
      background: var(--bg);
      min-height: 100vh;
      width: calc(100% - 78px);
      left: 78px;
      transition: all 0.5s ease;
      padding: 40px 30px;
    }
    .sidebar.open ~ .home-section { left:250px; width: calc(100% - 250px); }

    .dashboard-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:20px; }

    .card {
      background: var(--card);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,0.06);
    }
    .card h3 { margin-top:0; font-size:1.2rem; color:#333; }
    .card p { color:var(--muted); font-size:0.9rem; margin:4px 0; }
    .card .count { font-size:1.6rem; font-weight:700; margin-top:10px; color:var(--brand); }

    .shortcut-btn { display:flex; align-items:center; gap:10px; padding:12px 16px; border-radius:10px; background:#f3f4f6; text-decoration:none; color:#333; font-weight:600; transition:0.3s; }
    .shortcut-btn:hover { background:var(--brand); color:#fff; }
    .shortcut-btn i { font-size:1.4rem; }

    .event-card, .activity-card {
      background: var(--card);
      border-left:5px solid var(--brand);
      padding:16px 12px;
      border-radius:12px;
      box-shadow:0 4px 14px rgba(0,0,0,0.05);
      display:flex; flex-direction:column; justify-content:space-between; transition: transform 0.2s;
    }
    .event-card:hover, .activity-card:hover { transform: translateY(-3px); }
    .event-card h4, .activity-card h4 { margin:0 0 6px 0; font-size:1rem; color:#333; }
    .event-card small, .activity-card small { font-size:0.85rem; color:var(--muted); }

    @media(max-width:640px){
      .dashboard-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body data-current-user-id="{{ user.id|default:0 }}">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo-details">
      <i class='bx bxl-c-plus-plus icon'></i>
      <div class="logo_name">SchoolSync</div>
      <i class='bx bx-menu' id="btn" ></i>
    </div>
    <ul class="nav-list">
      <li><a href="/dashboard/" class="active"><i class='bx bx-home'></i> <span class="links_name">Home</span></a></li>
      <li><a href="/groups/"><i class='bx bx-group'></i> <span class="links_name">Groups</span></a></li>
      <li><a href="/homework/"><i class='bx bx-book'></i> <span class="links_name">Homework</span></a></li>
      <li><a href="/quizzes/"><i class='bx bx-dice-5'></i> <span class="links_name">Quizzes</span></a></li>
      
      <li><a href="/schedule/"><i class='bx bx-calendar-alt'></i> <span class="links_name">Schedule</span></a></li>
       <li style="position:relative">
        <a href="#" id="notifBellBtn" style="display:flex;align-items:center;gap:8px;color:inherit;text-decoration:none;">
          <i class='bx bx-bell'></i>
          <span class="links_name">Notifications</span>
          <span id="notifBadge" style="display:none;position:absolute;left:34px;top:-4px;background:#ef4444;color:#fff;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:700;">0</span>
        </a>
        <div id="notifDropdown" style="display:none;position:absolute;left:0;top:46px;z-index:999;background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,0.12);width:320px;border-radius:8px;padding:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Notifications</strong><button id="markAllRead" class="btn small">Mark all read</button></div>
          <div id="notifList" style="max-height:300px;overflow:auto;"></div>
          <div id="notifEmpty" style="color:var(--muted);text-align:center;padding:10px;display:none">No notifications</div>
        </div>
      </li>
      <li class="profile">
        <div class="profile-details">
          <i class='bx bx-user'></i>
          <div class="name_job">
            <div class="name">{{ username }}</div>
            <div class="job">{{ user.school_year }}</div>
          </div>
        </div>

          <!-- Notes panel -->
          <div style="margin-top:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <h2>Quick Notes</h2>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="refreshNotes" class="btn">Refresh</button>
              </div>
            </div>

            <div style="margin:12px 0 18px 0;">
              <form id="createNoteForm" style="display:flex;gap:8px;align-items:flex-start;">
                <textarea id="newNoteContent" placeholder="Write a quick note..." rows="3" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e6e9ee"></textarea>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <button type="submit" class="btn primary">Post</button>
                </div>
              </form>
            </div>

            <div id="notesContainer" aria-live="polite">
              <div id="notesLoading" style="color:var(--muted)">Loading notesâ€¦</div>
            </div>
          </div>
        <a href="#" id="log_out" style="color:#fff">Logout</a>
      </li>
    </ul>
  </div>

  <!-- Main Section -->
  <section class="home-section">
    <h2>Welcome, {{ username }}!</h2>
    
    <!-- Shortcuts -->
    <div class="dashboard-grid">
      <a href="/homework/" class="shortcut-btn"><i class='bx bx-book'></i> Homework</a>
      <a href="/quizzes/" class="shortcut-btn"><i class='bx bx-dice-5'></i> Quizzes</a>
      <a href="/groups/" class="shortcut-btn"><i class='bx bx-group'></i> Groups</a>
      <a href="/schedule/" class="shortcut-btn"><i class='bx bx-calendar-alt'></i> Schedule</a>
    </div>

    <!-- Stats Cards -->
    <div class="dashboard-grid" style="margin-top:25px;">
      <div class="card">
        <h3>Total Homework</h3>
        <p>Assignments assigned to you</p>
        <div class="count" id="homeworkCount">0</div>
      </div>
      <div class="card">
        <h3>Pending Quizzes</h3>
        <p>Quizzes to complete</p>
        <div class="count" id="quizCount">0</div>
      </div>
      <div class="card">
        <h3>Active Groups</h3>
        <p>Groups you are part of</p>
        <div class="count" id="groupCount">0</div>
      </div>
    </div>

    <!-- Upcoming Events -->
    <h3 style="margin-top:30px;">Upcoming Events</h3>
    <div class="dashboard-grid" id="upcomingEvents"></div>

    <!-- Recent Activity -->
    <h3 style="margin-top:30px;">Recent Activity</h3>
    <div class="dashboard-grid" id="recentActivity"></div>
  </section>

  <script>
  const apiSchedule = '/api/schedule/';
  const apiHomework = '/api/homework';
    // Helper to read cookie value
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const currentUserId = parseInt(document.body.dataset.currentUserId || '0', 10);

    async function loadNotes() {
      const container = document.getElementById('notesContainer');
      const loading = document.getElementById('notesLoading');
      loading.style.display = 'block';
      try {
        const res = await fetch('/api/homework/', { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Failed to load notes');
        const data = await res.json();
        loading.style.display = 'none';
        if (!Array.isArray(data)) {
          container.innerHTML = '<div style="color:var(--muted)">No notes yet.</div>';
          return;
        }
        container.innerHTML = '';
        data.forEach(note => {
          const el = document.createElement('div');
          el.style.border = '1px solid #e6e9ee';
          el.style.padding = '10px';
          el.style.borderRadius = '6px';
          el.style.marginBottom = '8px';
          el.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="color:var(--muted)">by ${note.created_by_username || 'you'}</div><div></div></div><div style="margin-top:6px">${escapeHtml(note.text || note.content || '')}</div>`;
          // delete button if mine
          if (note.created_by && note.created_by === currentUserId) {
            const del = document.createElement('button');
            del.className = 'btn small';
            del.textContent = 'Delete';
            del.style.marginTop = '8px';
            del.onclick = async () => {
              if (!confirm('Delete this note?')) return;
              const csrftoken = getCookie('csrftoken');
              const r = await fetch(`/api/homework/${note.id}/`, { method: 'DELETE', credentials: 'same-origin', headers: { 'X-CSRFToken': csrftoken } });
              if (r.ok) loadNotes(); else alert('Delete failed');
            };
            el.appendChild(del);
          }
          container.appendChild(el);
        });
      } catch (e) {
        loading.style.display = 'none';
        container.innerHTML = `<div style="color:var(--error)">${e.message}</div>`;
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    document.getElementById('refreshNotes').addEventListener('click', e => { e.preventDefault(); loadNotes(); });

    document.getElementById('createNoteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('newNoteContent').value.trim();
      if (!text) return;
      const csrftoken = getCookie('csrftoken');
      const res = await fetch('/api/homework/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ text })
      });
      if (res.ok) {
        document.getElementById('newNoteContent').value = '';
        loadNotes();
      } else {
        alert('Failed to post note');
      }
    });

    // initial load
    loadNotes();
  const apiQuizzes = '/api/quizzes';
  const apiGroups = '/api/groups';
    const csrftoken = (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'';

    function showNotification(msg,type='info',t=3500){
      let container = document.getElementById('notification-container');
      if(!container){ container = document.createElement('div'); container.id='notification-container'; container.style.position='fixed'; container.style.top='18px'; container.style.right='18px'; container.style.zIndex='9999'; document.body.appendChild(container);}
      const el = document.createElement('div'); el.textContent=msg;
      el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.marginTop='8px'; el.style.fontWeight='700';
      el.style.boxShadow='0 6px 18px rgba(2,6,23,0.08)';
      if(type==='success'){ el.style.background='linear-gradient(90deg,#10b981,#06b6d4)'; el.style.color='#fff'; }
      else if(type==='error'){ el.style.background='#ef4444'; el.style.color='#fff'; }
      else { el.style.background='#111827'; el.style.color='#fff'; }
      container.appendChild(el); setTimeout(()=> el.remove(),t);
    }

    // helper to fetch and safely parse JSON, with clearer errors
    async function fetchJson(url, opts = {}){
      const res = await fetch(url, Object.assign({ credentials: 'same-origin' }, opts));
      if (res.status === 401 || res.status === 403) {
        // not authenticated or not allowed
        throw new Error('Not authenticated');
      }
      if (!res.ok) throw new Error(`${url} returned ${res.status} ${res.statusText}`);
      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        const txt = await res.text();
        throw new Error(`${url} did not return JSON (content-type: ${ct}). Response length: ${txt.length}`);
      }
      return res.json();
    }

    async function loadDashboard(){
      try{
        // fetch counts in parallel but parse individually so we can report which failed
        const [hwPromise, quizPromise, groupPromise] = [fetchJson(apiHomework), fetchJson(apiQuizzes), fetchJson(apiGroups)];
        const [hwData, quizData, groupData] = await Promise.all([hwPromise, quizPromise, groupPromise]);

        document.getElementById('homeworkCount').textContent = Array.isArray(hwData) ? hwData.length : (hwData.count || 0);
        document.getElementById('quizCount').textContent = Array.isArray(quizData) ? quizData.length : (quizData.count || 0);
        document.getElementById('groupCount').textContent = Array.isArray(groupData) ? groupData.length : (groupData.count || 0);

        // Upcoming events
        let events = [];
        try{ events = await fetchJson(apiSchedule); } catch(e){ console.warn('Could not load events', e); }
        const upcomingEl = document.getElementById('upcomingEvents'); upcomingEl.innerHTML='';
        (events || []).slice(0,5).forEach(ev=>{
          const el = document.createElement('div'); el.className='event-card';
          el.innerHTML=`<h4>${ev.title}</h4><small>${new Date(ev.datetime).toLocaleString()}</small>`;
          upcomingEl.appendChild(el);
        });

        // Recent activity (from homework/quizzes)
        const recentEl = document.getElementById('recentActivity'); recentEl.innerHTML='';
        (Array.isArray(hwData) ? hwData.slice(-3) : []).forEach(hw=>{
          const el=document.createElement('div'); el.className='activity-card';
          const summary = (hw.content || '').split('\n')[0].slice(0,120) || 'Quick note';
          const created = hw.created_at ? new Date(hw.created_at).toLocaleString() : '';
          el.innerHTML=`<h4>Homework</h4><small>${created}</small><div style="margin-top:6px;color:var(--muted)">${escapeHtml(summary)}</div>`;
          recentEl.appendChild(el);
        });
        (Array.isArray(quizData) ? quizData.slice(-3) : []).forEach(qz=>{
          const el=document.createElement('div'); el.className='activity-card';
          const created = qz.created_at ? new Date(qz.created_at).toLocaleDateString() : '';
          el.innerHTML=`<h4>Quiz: ${escapeHtml(qz.title || 'Untitled')}</h4><small>${created || 'No date'}</small>`;
          recentEl.appendChild(el);
        });
      }catch(err){
        console.error('Dashboard load failed', err);
        if (err && err.message && err.message.includes('Not authenticated')){
          showNotification('Please log in to view the dashboard', 'error', 5000);
          // small delay then redirect to login page
          setTimeout(()=>{ window.location.href = '/login/'; }, 900);
          return;
        }
        // show the specific error message if present
        showNotification(`Could not load dashboard: ${err.message}`,'error');
      }
    }

    // Sidebar toggle
    const sidebar=document.querySelector('.sidebar'); const closeBtn=document.querySelector('#btn');
    if(closeBtn){ closeBtn.addEventListener('click',()=>{ sidebar.classList.toggle('open'); if(sidebar.classList.contains('open')) closeBtn.classList.replace('bx-menu','bx-menu-alt-right'); else closeBtn.classList.replace('bx-menu-alt-right','bx-menu'); }); }

    document.getElementById('log_out').addEventListener('click', async function(e){
      e.preventDefault();
      localStorage.removeItem('access');
      localStorage.removeItem('refresh');
      await fetch('/api/auth/logout',{method:'POST',credentials:'same-origin'});
      window.location.href='/';
    });

    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
  <script>
    // Notifications: fetch and render badge/dropdown
    const notifApi = '/api/notifications';
    async function loadNotifications(){
      try{
        const res = await fetch(notifApi, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Failed to load notifications');
        const data = await res.json();
        const unread = data.filter(n=>!n.is_read).length;
        const badge = document.getElementById('notifBadge');
        if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread>99? '99+' : String(unread); }
        else { badge.style.display='none'; }
        const list = document.getElementById('notifList'); list.innerHTML='';
        if(!data || data.length===0){ document.getElementById('notifEmpty').style.display='block'; return; } else document.getElementById('notifEmpty').style.display='none';
        data.forEach(n=>{
          const item = document.createElement('div');
          item.style.padding='8px'; item.style.borderBottom='1px solid #eef2f6'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
          item.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(n.message)}</div><div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div></div>`;
          const right = document.createElement('div'); right.style.marginLeft='8px';
          const mark = document.createElement('button'); mark.className='btn small'; mark.textContent = n.is_read? 'Read' : 'Mark';
          mark.onclick = async ()=>{
            if(n.is_read) return; // no-op
            const r = await fetch(`/api/notifications/${n.id}/read`, { method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'' } });
            if(r.ok){ n.is_read = true; mark.textContent='Read'; loadNotifications(); }
            else showNotification('Could not mark notification','error');
          };
          right.appendChild(mark);
          item.appendChild(right);
          list.appendChild(item);
        });
      }catch(e){ console.error(e); }
    }

    document.getElementById('notifBellBtn').addEventListener('click', (e)=>{
      e.preventDefault(); const d = document.getElementById('notifDropdown'); d.style.display = d.style.display==='none' || d.style.display===''? 'block' : 'none'; if(d.style.display==='block') loadNotifications();
    });

    document.getElementById('markAllRead').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const list = document.getElementById('notifList');
        const items = Array.from(list.children);
        for(const it of items){
          const btn = it.querySelector('button'); if(!btn) continue; btn.click();
        }
      }catch(err){ console.error(err); }
    });

    // load on start to populate badge
    loadNotifications();
  </script>
</body>
</html>
