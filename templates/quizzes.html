{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Quizzes | SchoolSync</title>
  <link rel="stylesheet" href="{% static 'home/style.css' %}">
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --card: #fff;
      --bg: #F6F8FB;
      --muted: #6B7280;
      --brand: #1d1b31;
      --accent: #EF4444;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(2,6,23,0.06);
    }

    /* page baseline */
    html,body { height:100%; }
    body {
      margin:0;
      background: linear-gradient(180deg,var(--bg) 0%, #f3f6fa 100%);
      font-family: Inter, system-ui, Arial, sans-serif;
      color: #0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* keep sidebar exactly as-is (no overrides) */
    .home-section{ padding-left:20px; min-height:100vh; }

    /* page header */
    .page-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:20px 24px;
      max-width:980px;
      margin:0 auto 8px;
    }
    .page-header .title {
      display:flex; flex-direction:column;
    }
    .page-header .title h1 {
      margin:0; font-size:20px; font-weight:700; color:var(--brand);
    }
    .page-header .title p {
      margin:4px 0 0 0; color:var(--muted); font-size:13px;
    }

    /* header actions */
    .actions {
      display:flex; gap:10px; align-items:center;
    }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700;
      border:1px solid rgba(15,23,42,0.06); background:#fff; color:var(--brand);
      box-shadow: 0 8px 18px rgba(2,6,23,0.04);
      transition:transform .12s ease, box-shadow .12s ease, background .12s;
    }
    .btn:hover{ transform:translateY(-3px); box-shadow: 0 14px 30px rgba(2,6,23,0.06); }
    .btn.primary {
      background:linear-gradient(135deg,var(--brand), #2a2846);
      color:#fff; border:none; box-shadow:0 10px 28px rgba(29,27,49,0.12);
    }
    .btn.ghost { background:transparent; box-shadow:none; border:1px dashed rgba(0,0,0,0.04); }

    /* main container */
    .hw-container {
      max-width:980px;
      margin:0 auto 48px;
      padding:18px;
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:20px;
      align-items:start;
    }

    /* left column (folders) */
    .folders-section {
      background: transparent;
    }

    .folders-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap:14px;
      margin-top:12px;
      opacity:0; transform:translateY(6px);
      transition:opacity .36s ease, transform .36s ease;
    }
    .folders-grid.visible{ opacity:1; transform:none }

    .folder-card {
      background:var(--card);
      padding:16px;
      border-radius:14px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:120px;
      text-decoration:none;
      color:inherit;
      border:1px solid rgba(15,23,42,0.03);
      transition: transform .14s ease, box-shadow .14s ease, border-color .12s;
    }
    .folder-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 40px rgba(2,6,23,0.08);
      border-color: rgba(29,27,49,0.06);
    }

    .folder-top { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
    .folder-info { display:flex; gap:10px; align-items:center; }
    .folder-icon {
      width:44px; height:44px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#fbfbfd,#f3f4ff); color:var(--brand);
      font-size:20px; box-shadow:0 6px 14px rgba(2,6,23,0.04);
    }
    .folder-title { font-weight:800; font-size:15px; color:var(--brand); }
    .folder-desc { color:#374151; font-size:13px; line-height:1.35; margin-top:6px; flex:1; }

    .folder-footer { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:auto; }
    .badge { background:#F1F5F9; padding:6px 10px; border-radius:999px; font-weight:700; color:var(--muted); font-size:13px; }
    .folder-actions { display:flex; gap:8px; align-items:center; }

    /* right column (activity) */
    .activity-card {
      background:var(--card);
      padding:14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,0.03);
    }
    .activity-row { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 0; border-bottom:1px solid #f3f5f8; }
    .activity-row:last-child{ border-bottom: none; }
    .activity-title { font-weight:700; color:var(--brand); font-size:14px; }
    .activity-meta { color:var(--muted); font-size:13px; text-align:right; }

    .progress {
      height:8px; background:#f1f3f6; border-radius:999px; overflow:hidden; width:100%; margin-top:8px;
    }
    .progress > i { display:block; height:100%; background:linear-gradient(90deg,#10b981,#06b6d4); }
/* highlight active sidebar item */
  .sidebar .nav-list a.active { background: #1d1b31; color: #fff; border-radius: 8px; padding: 8px 10px; display: inline-flex; align-items: center; gap:8px }
  .sidebar .nav-list li.active .links_name, .sidebar .nav-list a.active .links_name { color: #ffffff !important }
  .sidebar .nav-list a.active i { color: #fff }
    /* loading center */
    .loading { text-align:center; padding:28px 12px; color:var(--muted); }
    .spinner { width:36px; height:36px; border-radius:50%; border:4px solid #f3f4f6; border-top-color:var(--brand); animation:spin .8s linear infinite; margin:8px auto; }
    @keyframes spin { to{ transform: rotate(360deg) } }

    /* modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; align-items:center; justify-content:center; z-index:2200; }
    .modal-backdrop.open { display:flex; }
    .modal {
      width:680px; max-width:94%; background:var(--card); padding:20px; border-radius:14px; box-shadow:0 30px 70px rgba(2,6,23,0.18);
      transform:translateY(0); animation:pop .18s ease;
    }
    @keyframes pop { from{ transform: translateY(-8px) scale(.995); opacity:0 } to{ transform:none; opacity:1 } }
    .modal h3 { margin:0 0 8px; font-size:18px; color:var(--brand); }
    .modal .row { display:flex; gap:12px; margin-top:10px; align-items:center; }
    .modal label{ display:block; font-size:13px; color:#374151; margin-bottom:6px; font-weight:700; }
    .modal input, .modal textarea, .modal select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #E6E9EE; font-size:14px; }
    .modal .footer { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
    .hint { font-size:13px; color:var(--muted); margin-top:6px; }

    /* responsive */
    @media (max-width: 980px){
      .hw-container{ grid-template-columns: 1fr; padding:14px; }
      .page-header{ padding:12px; }
      .activity-card{ order:2; margin-top:18px; }
    }
  </style>
</head>
<body data-current-user-id="{{ user.id|default:0 }}">
  <!-- Sidebar (unchanged) -->
  <div class="sidebar">
    <div class="logo-details">
      <i class='bx bxl-c-plus-plus icon'></i>
      <div class="logo_name">schoolsync</div>
      <i class='bx bx-menu' id="btn" ></i>
    </div>
    <ul class="nav-list">
      <li><a href="/dashboard/"><i class='bx bx-home'></i> <span class="links_name">Home</span></a></li>
      <li><a href="/groups/"><i class='bx bx-group'></i> <span class="links_name">Groups</span></a></li>
      <li><a href="/homework/"><i class='bx bx-book'></i> <span class="links_name">Homework</span></a></li>
      <li><a href="/quizzes/" class="active"><i class='bx bx-dice-5'></i> <span class="links_name">Quizzes</span></a></li>
      
      <li><a href="/schedule/"><i class='bx bx-calendar-alt'></i> <span class="links_name">Schedule</span></a></li>
        <li style="position:relative">
        <a href="#" id="notifBellBtn" style="display:flex;align-items:center;gap:8px;color:inherit;text-decoration:none;">
          <i class='bx bx-bell'></i>
          <span class="links_name">Notifications</span>
          <span id="notifBadge" style="display:none;position:absolute;left:34px;top:-4px;background:#ef4444;color:#ffffff;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:700;">0</span>
        </a>
        <div id="notifDropdown" style="display:none;position:absolute;left:0;top:46px;z-index:999;background:var(--card);box-shadow:0 6px 20px rgba(0, 0, 0, 0.12);width:320px;border-radius:8px;padding:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><strong>Notifications</strong><button id="markAllRead" class="btn small">Mark all read</button></div>
          <div id="notifList" style="max-height:300px;overflow:auto;"></div>
          <div id="notifEmpty" style="color:var(--muted);text-align:center;padding:10px;display:none">No notifications</div>
        </div>
      </li>
      <li class="profile">
        <div class="profile-details">
          <i class='bx bx-user'></i>
          <div class="name_job">
            <div class="name">{{ username }}</div>
            <div class="job">{{ user.school_year }}</div>
          </div>
        </div>
        <a href="#" id="log_out" style="color:#fff">Logout</a>
      </li>
    </ul>
  </div>

  <!-- Page header -->
  <section class="home-section">
    <div class="page-header">
      <div class="title">
        <h1>Quizzes</h1>
        <p>Organize folders, create quizzes and track your activity.</p>
      </div>

      <div class="actions">
        <button id="openCreateFolderBtn" class="btn ghost"><i class='bx bx-folder-plus'></i> Create Folder</button>
      </div>
    </div>

    <!-- Main layout -->
    <div class="hw-container">
      <!-- Left: Folders -->
      <div class="folders-section">
        <div class="folders-grid" id="foldersGrid" aria-live="polite" aria-busy="true"></div>

        <div id="foldersPlaceholders" class="loading" style="display:none;">
          <div class="spinner"></div>
          <div id="foldersLoadingText">Loading folders…</div>
        </div>

        <div id="noFolders" class="loading" style="display:none">No folders yet. Create one to get started.</div>
      </div>

      <!-- Right: Activity -->
      <aside>
        <div class="activity-card">
          <h3 style="margin:0 0 8px 0">My Quiz Activity</h3>
          <div id="myActivityList" style="color:var(--muted); font-size:13px; min-height:64px;">
            Loading your quiz activity…
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- Create Folder Modal -->
  <div id="createFolderModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="createFolderTitle">
      <h3 id="createFolderTitle"><i class='bx bx-folder'></i> Create Quiz Folder</h3>

      <form id="createFolderForm">
        <div class="row" style="flex-direction:column;">
          <label for="folderName">Folder name</label>
          <input id="folderName" name="name" required maxlength="120" placeholder="e.g. Algebra Practice">
          <label for="folderDesc">Description</label>
          <textarea id="folderDesc" name="description" rows="3" placeholder="Short summary (optional)"></textarea>
          <div class="hint">Folder creators can delete their own folders later.</div>
        </div>

        <div class="footer">
          <button type="button" id="cancelCreate" class="btn">Cancel</button>
          <button type="submit" class="btn primary">Create folder</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Quiz Modal (quick create) -->
  <div id="createQuizModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="createQuizTitle">
      <h3 id="createQuizTitle"><i class='bx bx-edit'></i> Create Quick Quiz</h3>

      <form id="createQuizForm">
        <div class="row" style="gap:12px;">
          <div style="flex:1;">
            <label for="quizTitle">Quiz title</label>
            <input id="quizTitle" name="title" required placeholder="e.g. Chapter 2 - Fractions">
          </div>
          <div style="width:220px;">
            <label for="quizFolderSelect">Folder</label>
            <select id="quizFolderSelect" name="folder" required>
              <option value="">Choose folder</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label for="quizDesc">Short instructions</label>
          <textarea id="quizDesc" name="description" rows="2" placeholder="Optional short instructions"></textarea>
        </div>
        <div class="hint">This quick-quiz creates a quiz record. Add questions later in the folder detail page.</div>

        <div class="footer">
          <button type="button" id="cancelCreateQuiz" class="btn">Cancel</button>
          <button type="submit" class="btn primary">Create quiz</button>
        </div>
      </form>
    </div>
  </div>

  <div id="notification-container" style="position:fixed;top:18px;right:18px;z-index:9999"></div>

  <script>
    // CSRF & current user
    const csrftoken = (document.cookie.split(';').find(c => c.trim().startsWith('csrftoken=')) || '').split('=')[1] || '';
    const CURRENT_USER_ID = parseInt(document.body.dataset.currentUserId || '0', 10);

    // UI element refs
    const foldersGrid = document.getElementById('foldersGrid');
    const foldersPlaceholders = document.getElementById('foldersPlaceholders');
    const noFolders = document.getElementById('noFolders');
    const myActivityList = document.getElementById('myActivityList');

    const createFolderModal = document.getElementById('createFolderModal');
    const openCreateFolderBtn = document.getElementById('openCreateFolderBtn');
    const cancelCreateBtn = document.getElementById('cancelCreate');
    const createFolderForm = document.getElementById('createFolderForm');

  const createQuizModal = document.getElementById('createQuizModal');
    const cancelCreateQuizBtn = document.getElementById('cancelCreateQuiz');
    const createQuizForm = document.getElementById('createQuizForm');
    const quizFolderSelect = document.getElementById('quizFolderSelect');

    // Notifications
    function showNotification(msg, type='info', t=3500){
      const container = document.getElementById('notification-container');
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.padding = '10px 14px';
      el.style.borderRadius = '8px';
      el.style.marginTop = '8px';
      el.style.fontWeight = '700';
      el.style.boxShadow = '0 6px 18px rgba(2,6,23,0.08)';
      if(type === 'success'){ el.style.background = 'linear-gradient(90deg,#10b981,#06b6d4)'; el.style.color = '#fff'; }
      else if(type === 'error'){ el.style.background = '#ef4444'; el.style.color = '#fff'; }
      else { el.style.background = '#111827'; el.style.color = '#fff'; }
      container.appendChild(el);
      setTimeout(()=> el.remove(), t);
    }

    // Sidebar toggle (preserve existing behavior)
    const sidebar = document.querySelector(".sidebar"), closeBtn = document.querySelector("#btn");
    if(closeBtn){ closeBtn.onclick = ()=> { sidebar.classList.toggle("open"); closeBtn.classList.toggle("bx-menu-alt-right"); closeBtn.classList.toggle("bx-menu"); } }

    // logout
    const logoutEl = document.getElementById('log_out');
    if(logoutEl) logoutEl.onclick = async e => { e.preventDefault(); await fetch('/api/auth/logout', { method:'POST', credentials:'same-origin' }); window.location = '/'; };

    // Helpers for modal open/close
    function openModal(node){ node.classList.add('open'); node.setAttribute('aria-hidden','false'); const focusable = node.querySelector('input,select,textarea,button'); if(focusable) focusable.focus();}
    function closeModal(node){ node.classList.remove('open'); node.setAttribute('aria-hidden','true'); node.querySelectorAll('form').forEach(f=>f.reset()); }

    openCreateFolderBtn.addEventListener('click', e => { e.preventDefault(); openModal(createFolderModal); });
    cancelCreateBtn.addEventListener('click', e => { e.preventDefault(); closeModal(createFolderModal); });
    createFolderModal.addEventListener('click', e => { if(e.target === createFolderModal) closeModal(createFolderModal); });

  // (Create Quiz button removed from this page; open modal via folder detail page instead)
    cancelCreateQuizBtn.addEventListener('click', e => { e.preventDefault(); closeModal(createQuizModal); });
    createQuizModal.addEventListener('click', e => { if(e.target === createQuizModal) closeModal(createQuizModal); });

    document.addEventListener('keydown', e => {
      if(e.key === 'Escape'){
        if(createFolderModal.classList.contains('open')) closeModal(createFolderModal);
        if(createQuizModal.classList.contains('open')) closeModal(createQuizModal);
      }
    });

    // Render folder card
    function renderFolderCard(f){
      const a = document.createElement('a');
      a.href = `/quizzes/${f.id}/`;
      a.className = 'folder-card';
      a.setAttribute('aria-label', f.name || 'Folder');

      const top = document.createElement('div'); top.className = 'folder-top';
      const info = document.createElement('div'); info.className = 'folder-info';

      const icon = document.createElement('div'); icon.className = 'folder-icon'; icon.innerHTML = "<i class='bx bx-folder'></i>";
      const meta = document.createElement('div');
      const title = document.createElement('div'); title.className = 'folder-title'; title.textContent = f.name || 'Untitled';
      const count = (typeof f.quizzes_count !== 'undefined') ? f.quizzes_count : (f.count || 0);
      const caption = document.createElement('div'); caption.className = 'hint'; caption.style.fontSize='13px'; caption.style.color='var(--muted)'; caption.textContent = f.description || '';

      meta.appendChild(title);
      info.appendChild(icon);
      info.appendChild(meta);

      top.appendChild(info);

      const footer = document.createElement('div'); footer.className = 'folder-footer';
      const badge = document.createElement('div'); badge.className = 'badge'; badge.textContent = `${count} ${count===1?'quiz':'quizzes'}`;
      const actions = document.createElement('div'); actions.className = 'folder-actions';

      // if owner, show delete button
      if(f.created_by_id && f.created_by_id === CURRENT_USER_ID){
        const del = document.createElement('button'); del.className = 'btn'; del.style.border = '1px solid rgba(239,68,68,0.12)'; del.style.color = '#ef4444';
        del.textContent = 'Delete';
        del.onclick = async function(ev){
          ev.preventDefault();
          if(!confirm('Delete folder? This cannot be undone.')) return;
          try{
            const r = await fetch(`/api/quizzes/folders/${f.id}`, { method:'DELETE', credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } });
            if(!r.ok) { const t = await r.text(); throw new Error(t||'Delete failed'); }
            showNotification('Folder deleted','success');
            await loadFolders();
          }catch(err){ showNotification('Could not delete folder','error'); }
        };
        actions.appendChild(del);
      }

      footer.appendChild(badge);
      footer.appendChild(actions);

      a.appendChild(top);
      a.appendChild(caption);
      a.appendChild(footer);
      return a;
    }

    // Load folders
    async function loadFolders(){
      foldersGrid.classList.remove('visible');
      foldersGrid.innerHTML = '';
      noFolders.style.display = 'none';
      foldersPlaceholders.style.display = 'block';
      try{
        const res = await fetch('/api/quizzes/folders', { credentials:'same-origin' });
        if(!res.ok) throw new Error('Could not load folders');
        const data = await res.json();
        if(Array.isArray(data) && data.length){
          data.forEach(f => { foldersGrid.appendChild(renderFolderCard(f)); });
          foldersGrid.classList.add('visible');
          foldersPlaceholders.style.display = 'none';
        } else {
          foldersPlaceholders.style.display = 'none';
          noFolders.style.display = 'block';
        }
      }catch(err){
        foldersPlaceholders.style.display = 'none';
        noFolders.style.display = 'block';
        showNotification('Could not load folders','error');
      }
    }

    // Load My Activity
    async function loadMyActivity(){
      myActivityList.textContent = 'Loading your quiz activity…';
      try{
        const res = await fetch('/api/quizzes/my-activity', { credentials:'same-origin' });
        if(!res.ok) throw new Error('Network');
        const data = await res.json();
        if(!Array.isArray(data) || data.length===0){
          myActivityList.textContent = 'No activity yet. Take some quizzes to build your activity.';
          return;
        }
        myActivityList.innerHTML = '';
        data.forEach(item => {
          const row = document.createElement('div'); row.className = 'activity-row';
          const left = document.createElement('div');
          left.innerHTML = `<div class="activity-title"><a href="/quizzes/${item.quiz.id}/take/" style="text-decoration:none;color:var(--brand)">${item.quiz.title}</a></div>
                            <div style="color:var(--muted);font-size:13px">Folder: ${item.quiz.folder_name || '—'}</div>`;
          const right = document.createElement('div'); right.className = 'activity-meta';
          right.innerHTML = `Best: <strong>${item.best_score!==null?item.best_score+'%':'—'}</strong><br>Last: ${item.last_score!==null?item.last_score+'%':'—'}<br><small style="color:var(--muted)">Attempts: ${item.attempts_count}</small>`;
          row.appendChild(left); row.appendChild(right); myActivityList.appendChild(row);
        });
      }catch(err){
        myActivityList.textContent = 'Could not load activity';
      }
    }

    // Create folder submit
    createFolderForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const name = (document.getElementById('folderName').value || '').trim();
      const description = (document.getElementById('folderDesc').value || '').trim();
      if(!name){ showNotification('Folder name required','error'); return; }
      const btn = createFolderForm.querySelector('button.primary'); btn.disabled = true;
      try{
        const res = await fetch('/api/quizzes/folders', {
          method:'POST',
          credentials:'same-origin',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify({ name, description })
        });
        if(!res.ok){
          let body = null;
          try{ body = await res.clone().json(); }
          catch(e){
            try{ body = await res.clone().text(); }catch(e2){ body = null; }
          }
          throw new Error((body && body.detail) || body || 'Create failed');
        }
        await res.json();
        closeModal(createFolderModal);
        showNotification('Folder created','success');
        await loadFolders();
        await populateQuizFolderSelect(); // keep select up-to-date
      }catch(err){
        showNotification(err.message || 'Could not create folder','error',7000);
      }finally{ btn.disabled = false; }
    });

    // Populate folder select for quick-quiz form
    async function populateQuizFolderSelect(){
      quizFolderSelect.innerHTML = '<option value="">Choose folder</option>';
      try{
        const res = await fetch('/api/quizzes/folders', { credentials:'same-origin' });
        if(!res.ok) return;
        const data = await res.json();
        if(Array.isArray(data)) data.forEach(f => {
          const o = document.createElement('option'); o.value = f.id; o.textContent = f.name;
          quizFolderSelect.appendChild(o);
        });
      }catch(e){ /* ignore */ }
    }

    // Create quick quiz submit
    createQuizForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const title = (document.getElementById('quizTitle').value || '').trim();
      const folder = (document.getElementById('quizFolderSelect').value || '').trim();
      const description = (document.getElementById('quizDesc').value || '').trim();
      if(!title || !folder){ showNotification('Title and folder are required','error'); return; }
      const btn = createQuizForm.querySelector('button.primary'); btn.disabled = true;
      try{
        const res = await fetch('/api/quizzes', {
          method:'POST',
          credentials:'same-origin',
          headers: { 'Content-Type':'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify({ title, folder: parseInt(folder,10), description })
        });
        if(!res.ok){
          let body = null;
          try{ body = await res.clone().json(); }
          catch(e){
            try{ body = await res.clone().text(); }catch(e2){ body = null; }
          }
          throw new Error((body && body.detail) || body || 'Create failed');
        }
        await res.json();
        closeModal(createQuizModal);
        showNotification('Quiz created (add questions in folder)','success');
        await loadFolders();
      }catch(err){
        showNotification(err.message || 'Could not create quiz','error',7000);
      }finally{ btn.disabled = false; }
    });

    // Modal backdrop click close
    createFolderModal.addEventListener('click', e => { if(e.target === createFolderModal) closeModal(createFolderModal); });
    createQuizModal.addEventListener('click', e => { if(e.target === createQuizModal) closeModal(createQuizModal); });

    // Populate and initialize page
    document.addEventListener('DOMContentLoaded', async function(){
      await loadFolders();
      await loadMyActivity();
      await populateQuizFolderSelect();
    });
  </script>
  <script>
    // Notifications: fetch and render badge/dropdown
    const notifApi = '/api/notifications';
    async function loadNotifications(){
      try{
        const res = await fetch(notifApi, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Failed to load notifications');
        const data = await res.json();
        const unread = data.filter(n=>!n.is_read).length;
        const badge = document.getElementById('notifBadge');
        if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread>99? '99+' : String(unread); }
        else { badge.style.display='none'; }
        const list = document.getElementById('notifList'); list.innerHTML='';
        if(!data || data.length===0){ document.getElementById('notifEmpty').style.display='block'; return; } else document.getElementById('notifEmpty').style.display='none';
        data.forEach(n=>{
          const item = document.createElement('div');
          item.style.padding='8px'; item.style.borderBottom='1px solid #eef2f6'; item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center';
          item.innerHTML = `<div style="flex:1"><div style="font-weight:700">${escapeHtml(n.message)}</div><div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div></div>`;
          const right = document.createElement('div'); right.style.marginLeft='8px';
          const mark = document.createElement('button'); mark.className='btn small'; mark.textContent = n.is_read? 'Read' : 'Mark';
          mark.onclick = async ()=>{
            if(n.is_read) return; // no-op
            const r = await fetch(`/api/notifications/${n.id}/read`, { method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'' } });
            if(r.ok){ n.is_read = true; mark.textContent='Read'; loadNotifications(); }
            else showNotification('Could not mark notification','error');
          };
          right.appendChild(mark);
          item.appendChild(right);
          list.appendChild(item);
        });
      }catch(e){ console.error(e); }
    }

    document.getElementById('notifBellBtn').addEventListener('click', (e)=>{
      e.preventDefault(); const d = document.getElementById('notifDropdown'); d.style.display = d.style.display==='none' || d.style.display===''? 'block' : 'none'; if(d.style.display==='block') loadNotifications();
    });

    document.getElementById('markAllRead').addEventListener('click', async (e)=>{
      e.preventDefault();
      try{
        const r = await fetch('/api/notifications/mark_all_read', { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1]||'' } });
        if(r.ok) loadNotifications(); else showNotification('Could not mark all read','error');
      }catch(err){ console.error(err); }
    });

    // load on start to populate badge
    loadNotifications();
  </script>
</body>
</html>
<script>
  async function loadNotificationsQuizzes(){
    try{
      const res = await fetch('/api/notifications', { credentials: 'same-origin' });
      if(!res.ok) return;
      const data = await res.json();
      const unread = data.filter(n=>!n.is_read).length;
      const badge = document.getElementById('notifBadge_quizzes');
      if(!badge) return;
      if(unread>0){ badge.style.display='inline-block'; badge.textContent = unread>99? '99+' : String(unread);} else badge.style.display='none';
    }catch(e){ console.error(e); }
  }
  document.addEventListener('DOMContentLoaded', loadNotificationsQuizzes);
</script>
